<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Overlay Chat Twitch – ansoquest</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --box-width: 345px;
      --box-height: 678px;
      --pad: 10px;
      --gap: 14px;          /* espace entre messages */
      --fade-top-1: 0px;    /* début du fondu (haut) */
      --fade-top-2: 24px;   /* progressif */
      --fade-top-3: 56px;   /* opaque à partir d’ici */
    }

    html, body { height:100%; margin:0; background:transparent; overflow:hidden; }
    body { font-family:'Space Grotesk',sans-serif; color:#fff; }

    #wrap{
      position:absolute; inset:0;
      display:flex; justify-content:flex-end; align-items:flex-end;
      pointer-events:none;
      padding:12px;
    }

    .chat-box{
      position:relative;
      width:var(--box-width);
      height:var(--box-height);
      overflow:hidden;              /* on masque ce qui sort en haut */
      background:transparent;
      border-radius:16px;
    }

    /* Flux collé en bas, sans scroll visible.
       Le "fondu" du haut est géré par un mask (invisible en design, juste une opacité). */
    #chat{
      position:absolute; inset:var(--pad);
      display:flex; flex-direction:column; justify-content:flex-end;
      gap:var(--gap);
      overflow:hidden;
      scrollbar-width:none;

      /* Fondu d’opacité en haut : transparent -> semi -> opaque */
      -webkit-mask-image: linear-gradient(
        to bottom,
        rgba(0,0,0,0) var(--fade-top-1),
        rgba(0,0,0,0.35) var(--fade-top-2),
        rgba(0,0,0,1) var(--fade-top-3),
        rgba(0,0,0,1) 100%
      );
              mask-image: linear-gradient(
        to bottom,
        rgba(0,0,0,0) var(--fade-top-1),
        rgba(0,0,0,0.35) var(--fade-top-2),
        rgba(0,0,0,1) var(--fade-top-3),
        rgba(0,0,0,1) 100%
      );
    }
    #chat::-webkit-scrollbar{ display:none; }

    .msg{ animation:fadeIn .18s ease both; max-width:100%; }
    /* 1ère ligne : pseudo en bulle */
    .user-line{ display:flex; align-items:center; gap:6px; }
    .name{
      font-weight:600; font-size:13px; line-height:1.25;
      color:#000; background:#fff; border-radius:999px;
      padding:2px 9px; display:inline-block; max-width:100%;
      text-overflow:ellipsis; white-space:nowrap; overflow:hidden;
    }
    /* 2e ligne : texte (interligne légèrement réduit) */
    .text-line{
      margin-top:2px;
      font-size:16px; line-height:1.35;   /* ← plus serré */
      color:#fff;
      text-shadow:0 1px 2px rgba(0,0,0,.45);
      overflow-wrap:anywhere;
    }

    #status{ display:none; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(4px);} to{opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="chat-box">
      <div id="status">Connecting…</div>
      <div id="chat"></div>
    </div>
  </div>

  <script>
    const CHANNEL = 'ansoquest';
    const SHOW_DEBUG = false;

    const chat = document.getElementById('chat');
    const statusEl = document.getElementById('status');
    const setStatus = t=>statusEl.textContent=t;
    const log = (...a)=>SHOW_DEBUG&&console.log(...a);

    function addMessage({ displayName, message }){
      const msg = document.createElement('div'); msg.className='msg';

      const userLine = document.createElement('div'); userLine.className='user-line';
      const name = document.createElement('span'); name.className='name';
      name.textContent = displayName || 'User';
      userLine.appendChild(name);

      const text = document.createElement('div'); text.className='text-line';
      text.textContent = message;

      msg.appendChild(userLine);
      msg.appendChild(text);

      chat.appendChild(msg); // s’ajoute en bas, les anciens remontent et "passent" sous le mask d’opacité
    }

    // ====== WebSocket IRC Twitch (sans librairie) ======
    const WS_URL='wss://irc-ws.chat.twitch.tv:443';
    let ws, pingTimer, reconnectTimer;
    const send = s => ws && ws.readyState===1 && ws.send(s+'\r\n');

    function connect(){
      clearTimeout(reconnectTimer); try{ ws && ws.close(); }catch(_){}
      ws = new WebSocket(WS_URL);

      ws.addEventListener('open', ()=>{
        setStatus('');
        send('CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership');
        const nick = 'justinfan' + Math.floor(Math.random()*100000);
        send('PASS SCHMOOPIIE'); send(`NICK ${nick}`); send(`JOIN #${CHANNEL}`);
        clearInterval(pingTimer);
        pingTimer = setInterval(()=>{ try{ send('PING :keepalive'); }catch(_){}} , 240000);
      });

      ws.addEventListener('message', (ev)=>{
        const data = ev.data;
        if (data.startsWith('PING')) { send('PONG :tmi.twitch.tv'); return; }

        data.split('\r\n').forEach(line=>{
          if (!line) return;
          if (line.includes('PRIVMSG')){
            const tagsPart = line.startsWith('@') ? line.slice(1, line.indexOf(' ')) : '';
            const rest = tagsPart ? line.slice(tagsPart.length + 2) : line;
            const msgIdx = rest.indexOf(' :');
            const meta = rest.slice(0, msgIdx);
            const message = rest.slice(msgIdx + 2);

            const tags = {};
            if (tagsPart) tagsPart.split(';').forEach(kv=>{
              const [k,v] = kv.split('=');
              tags[k] = decodeURIComponent(v || '');
            });

            const displayName = tags['display-name'] || meta.split('!')[0].replace(':','');

            addMessage({ displayName, message });
          }
        });
      });

      ws.addEventListener('close', ()=>{
        clearInterval(pingTimer);
        reconnectTimer = setTimeout(connect, 1500);
      });
      ws.addEventListener('error', ()=>{
        try{ ws.close(); }catch(_){}
      });
    }
    connect();

    // Mode démo : .../?demo=1
    if (new URLSearchParams(location.search).get('demo')==='1'){
      let i=1;
      setInterval(()=>addMessage({
        displayName:'DemoUser',
        message:`Message de test #${i++}`
      }), 800);
    }
  </script>
</body>
</html>
