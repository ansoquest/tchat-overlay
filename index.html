<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Overlay Chat Twitch – ansoquest</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --box-width: 345px;
      --box-height: 678px;
      --box-radius: 16px;
      --box-pad: 10px;
    }

    html, body { height:100%; margin:0; background:transparent; overflow:hidden; }
    body { font-family:'Space Grotesk',sans-serif; color:#fff; }

    /* L'overlay entier est déplaçable librement dans OBS */
    #wrap {
      position:absolute; inset:0;
      display:flex; justify-content:flex-end; align-items:flex-end;
      pointer-events:none; /* ne bloque pas Figma */
      padding:12px;
    }

    /* La box du chat (sans dégradés, sans scrollbar visible) */
    .chat-box {
      position:relative;
      width: var(--box-width);
      height: var(--box-height);
      overflow: hidden;            /* on masque les messages qui sortent par le haut */
      border-radius: var(--box-radius);
      background: rgba(0,0,0,.18); /* léger fond pour lisibilité, modifie/retire si tu veux */
      box-shadow: 0 4px 24px rgba(0,0,0,.25);
      backdrop-filter: blur(2px);
    }

    /* Flux calé en bas : les nouveaux s’ajoutent et poussent les anciens vers le haut */
    #chat {
      position:absolute; inset: var(--box-pad);
      display:flex; flex-direction:column; justify-content:flex-end;
      gap:8px;
      overflow:hidden;             /* pas de scroll, on reste calé en bas */
    }

    .msg { max-width: 96%; animation: fadeInUp .22s ease both; }
    .user-line {
      display:flex; align-items:center; gap:6px; margin-bottom:3px;
    }
    /* Pseudo à droite */
    .name {
      margin-left:auto;            /* pousse le pseudo à droite */
      font-weight:600; font-size:13px; color:#000;
      background:rgba(255,255,255,0.95);
      border-radius:999px; padding:2px 9px; line-height:1.25; display:inline-block;
    }
    .text-line {
      font-weight:400; font-size:16px; line-height:1.45; color:#fff;
      text-shadow:0 2px 4px rgba(0,0,0,.55);
      overflow-wrap:anywhere;
    }

    /* Statut masqué (tu peux repasser en display:block si besoin debug) */
    #status { display:none; }

    @keyframes fadeInUp { from{opacity:0;transform:translateY(6px);} to{opacity:1;transform:translateY(0);} }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="chat-box">
      <div id="status">⏳ Connecting…</div>
      <div id="chat"></div>
    </div>
  </div>

  <script>
    const CHANNEL = 'ansoquest';
    const SHOW_DEBUG = false;

    const chat = document.getElementById('chat');
    const statusEl = document.getElementById('status');
    const setStatus = t=>{ if(statusEl) statusEl.textContent=t; };
    const log = (...a)=>SHOW_DEBUG&&console.log(...a);

    // Ajoute un message en bas, sans suppression ; les plus anciens sortent par le haut (overflow hidden)
    function addMessage({displayName,message}){
      const msg=document.createElement('div'); msg.className='msg';

      const userLine=document.createElement('div'); userLine.className='user-line';
      const name=document.createElement('span'); name.className='name';
      name.textContent=displayName||'User';

      const textLine=document.createElement('div'); textLine.className='text-line';
      textLine.textContent=message;

      userLine.appendChild(name);
      msg.appendChild(userLine);
      msg.appendChild(textLine);

      chat.appendChild(msg);
      // Rester calé en bas visuellement (sans scrollbar)
      // (pas besoin de scrollTop ici car overflow:hidden et justify-content:flex-end)
    }

    // ====== Twitch IRC via WebSocket (sans librairie) ======
    const WS_URL='wss://irc-ws.chat.twitch.tv:443';
    let ws,pingTimer,reconnectTimer;
    const send=s=>ws&&ws.readyState===1&&ws.send(s+'\r\n');

    function connect(){
      clearTimeout(reconnectTimer); try{ws&&ws.close();}catch(_){}
      ws=new WebSocket(WS_URL);

      ws.addEventListener('open',()=>{
        setStatus(''); log('WS open');
        send('CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership');
        const nick='justinfan'+Math.floor(Math.random()*100000);
        send('PASS SCHMOOPIIE'); send(`NICK ${nick}`); send(`JOIN #${CHANNEL}`);
        clearInterval(pingTimer);
        pingTimer=setInterval(()=>{try{send('PING :keepalive');}catch(_){}} ,240000);
      });

      ws.addEventListener('message',ev=>{
        const data=ev.data;
        if(data.startsWith('PING')){send('PONG :tmi.twitch.tv');return;}

        data.split('\r\n').forEach(line=>{
          if(!line)return;
          if(line.includes('PRIVMSG')){
            const tagsPart=line.startsWith('@')?line.slice(1,line.indexOf(' ')):'';
            const rest=tagsPart?line.slice(tagsPart.length+2):line;
            const msgIdx=rest.indexOf(' :');
            const meta=rest.slice(0,msgIdx);
            const message=rest.slice(msgIdx+2);

            const tags={}; if(tagsPart) tagsPart.split(';').forEach(kv=>{const[k,v]=kv.split('=');tags[k]=decodeURIComponent(v||'');});
            const displayName=tags['display-name']||meta.split('!')[0].replace(':','');

            addMessage({displayName,message});
          }
        });
      });

      ws.addEventListener('close',()=>{ clearInterval(pingTimer); reconnectTimer=setTimeout(connect,1500); });
      ws.addEventListener('error',()=>{ try{ws.close();}catch(_){}} );
    }
    connect();

    // Mode démo : .../?demo=1
    if(new URLSearchParams(location.search).get('demo')==='1'){
      let i=1;
      setInterval(()=>addMessage({displayName:'DemoUser',message:`Message de test #${i++}`}), 900);
    }
  </script>
</body>
</html>
